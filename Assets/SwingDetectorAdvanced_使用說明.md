# 🎮 SwingDetectorAdvanced - 改良版說明

## ✨ 核心改進

### 問題分析與解決方案

| 問題 | 原因 | 解決方法 |
|------|------|---------|
| 純 Gyro 誤判 | 換姿勢時角速度爆炸（>1000°/s） | 用 `deviceRotation` 變化區分轉向 vs 揮動 |
| 純加速度漂移 | 轉向改變靜態重力分量 | 轉換到世界座標 + 校準 |
| 回彈問題 | 揮後反彈產生反向加速度 | 峰值檢測 + 反向抑制 |

### 新的檢測邏輯

```csharp
1. 取得 deviceRotation → 計算旋轉速度
   ↓
2. 如果旋轉速度 > 120°/s → 判定為「轉向」→ 忽略揮動
   ↓
3. 如果不是轉向 → 檢查加速度（世界座標）
   ↓
4. 找到加速度峰值 → 判定方向
   ↓
5. 檢查是否為回彈（反向） → 抑制
```

---

## ⚙️ 參數設定

### 快速設定（推薦）

```
=== 檢測參數 ===
Accel Threshold: 2.5
Rotation Speed Threshold: 250 (度/秒) ← 重要！
Ignore Swing While Rotating: ✅

=== 靈敏度 ===
Accel Smoothing: 0.6
Noise Threshold: 0.1

=== 回彈抑制 ===
Enable Bounce Suppress: ✅
Bounce Supress Time: 0.2

=== 自動校準 ===
Enable Auto Calibration: ✅
Idle Calibration Time: 5

=== 方向 ===
Enable Diagonal Detection: ❌ (節奏遊戲用四方向)
Cooldown Time: 0.15
```

---

## 🔍 關鍵參數說明

### `Rotation Speed Threshold` (旋轉速度門檻)
**這是新的關鍵參數！**

```
作用：區分「揮動」和「轉向」

deviceRotation 每幀變化超過此值 → 視為轉向 → 忽略揮動偵測
```

**⚠️ 重要：這個值需要設定得比較高！**

**為什麼？**
- 揮動時手把也會產生旋轉分量（50-200°/s）
- 如果門檻太低（120），正常揮動會被誤判為轉向
- 真正的「改變握法」通常是緩慢旋轉（< 100°/s）

**調整建議：**
- **預設 250°/s** - 適合大多數情況
- **靈敏版 200°/s** - 如果經常換握法
- **穩定版 300°/s** - 如果揮動常被誤判為轉向
- ❌ 太低（< 150）- 揮動會被當成轉向

**實測數值參考：**
```
動作                    旋轉速度
----------------------  ------------
靜止不動                0-10°/s
慢慢改變握法            30-80°/s
快速改變握法            100-150°/s
普通揮動                50-200°/s ← 重疊區！
用力揮動                200-400°/s
邊揮邊大幅轉向          400+°/s
```

**測試方法：**
```
1. 開啟 Show Detailed Debug
2. 測試各種動作，觀察 Console 的旋轉速度

測試 A：慢慢改變握法（45度轉向）
→ 應該看到：[轉向中 80°/s]
→ 如果沒出現：降低門檻到 150

測試 B：普通揮動（不改變握法）
→ 不應該出現：[轉向中]
→ 如果出現：提高門檻到 300

測試 C：用力揮動
→ 可能出現：[轉向中 250°/s]（正常）
→ 但不影響揮動偵測（峰值在轉向前已記錄）
```

**進階選項：不使用轉向判定**
```
如果調整後還是無法區分：
Ignore Swing While Rotating: ❌（不勾選）

缺點：改變握法時可能誤判
優點：不會漏掉任何揮動
```

### `Ignore Swing While Rotating` (轉向時忽略揮動)
```
✅ 勾選（推薦）：轉向時完全不偵測揮動
❌ 不勾選：即使轉向也會嘗試偵測（容易誤判）
```

### `Accel Threshold` (加速度門檻)
```
作用：揮動的最小強度

太低（1.0）→ 輕微移動就觸發
太高（5.0）→ 要很用力才偵測到

建議：2.0 ~ 3.5
```

---

## 🧪 測試流程

### 1. 校準測試
```
執行遊戲 → 靜止 2 秒 → 
Console: [Calibration] 完成！重力偏移: (0.01, -9.81, 0.02)
```

### 2. 轉向測試（關鍵！）
```
開啟 Show Detailed Debug

測試：慢慢轉動手把 45°
結果：Accel: 0.02 [轉向中 150°/s] ✅
說明：偵測到轉向，不會觸發揮動

測試：快速揮動
結果：Accel: 3.50 ✅
說明：沒有轉向訊息，正常偵測揮動
```

### 3. 方向測試
```
直握揮上 → [SWING] Up ✅
斜握揮上 → [SWING] Up ✅（不受握法影響）
倒握揮上 → [SWING] Up ✅（座標轉換正確）
```

### 4. 回彈測試
```
快速向上揮 → 自然落下

舊版：
[SWING] Up
[SWING] Down ← 誤判

新版：
[SWING] Up
[Bounce] 抑制反向: Down ← 成功！
```

---

## 🎯 運作原理圖解

### 揮動 vs 轉向

```
=== 揮動（正常偵測）===
deviceRotation: 無明顯變化（< 120°/s）
加速度: 突然增大（> 2.5）
↓
偵測到揮動 ✅

=== 轉向（忽略）===
deviceRotation: 明顯變化（> 120°/s）
加速度: 可能有變化
↓
判定為轉向，忽略揮動 ❌

=== 邊揮邊轉（忽略）===
deviceRotation: 明顯變化（> 120°/s）
加速度: 明顯增大
↓
因為有轉向，忽略 ❌
```

### 峰值檢測

```
加速度變化：
時間: 0.0   0.1   0.2   0.3   0.4   0.5
      1.0 → 2.5 → 4.2 → 3.8 → 1.5 → 0.5
                    ↑ 峰值（4.2）
                    在這裡記錄方向
                         ↓
                      峰值結束（< 2.5）
                      ↓
                    判定方向並觸發
```

好處：
- ✅ 不會在加速中途就判定
- ✅ 找到最強的那一刻
- ✅ 避免重複偵測

---

## 🐛 疑難排解

### Q1: 轉動手把還是會觸發揮動

**檢查：**
```
Show Detailed Debug: ✅
慢慢轉動手把
看 Console 是否顯示 [轉向中]
```

**解決：**
```
如果沒顯示轉向：
Rotation Speed Threshold: 120 → 80（降低門檻）

如果顯示了但還是觸發：
Ignore Swing While Rotating: 確認有勾選
```

### Q2: 揮動經常被忽略 / 稍微移動就判定為轉向

**原因：** `Rotation Speed Threshold` 太低，正常揮動的旋轉分量超過門檻

**解決：**
```
方案 1（推薦）：
Rotation Speed Threshold: 250 → 300 或 350（提高門檻）

方案 2：
Ignore Swing While Rotating: ❌（關閉轉向判定）
→ 優點：不會漏掉揮動
→ 缺點：改變握法時可能誤判

方案 3（如果方案1和2都不理想）：
使用舊版 SwingDetector（有自動校正功能）
```

**檢查方法：**
```
開啟 Show Detailed Debug
正常揮動一次
觀察 Console：

如果看到 [轉向中 XXX°/s]：
→ XXX 是多少？
→ 如果 < 250，說明門檻太低
→ 建議設為 XXX + 50
```

### Q3: 方向判定不準

**檢查：**
```
1. 是否已校準？（看 Console）
2. 握法改變後是否重新校準？
```

**解決：**
```
按 Y 鍵手動校準
或
靜止 5 秒等自動校準
```

### Q4: 回彈還是會觸發

**解決：**
```
Bounce Supress Time: 0.2 → 0.3
Enable Bounce Suppress: 確認有勾選
```

### Q5: 反應太慢

**解決：**
```
Accel Smoothing: 0.6 → 0.8（更即時）
Accel Threshold: 2.5 → 2.0（更敏感）
Cooldown Time: 0.15 → 0.1（更快）
```

---

## 📊 與舊版比較

| 特性 | 舊版 (SwingDetector) | 新版 (Advanced) |
|------|---------------------|-----------------|
| 主要感測器 | 加速度 | 加速度（世界座標） |
| 轉向處理 | 轉向後自動校正 | **即時區分轉向** |
| 握法改變 | 需要等待校正 | **即時處理（座標轉換）** |
| 回彈抑制 | ❌ 無 | ✅ 有 |
| 反應速度 | 中等 | 快 |
| 適用場景 | 一般遊戲 | 節奏遊戲 |

---

## 💡 使用技巧

### 1. 遊戲開始時
```csharp
// 重置狀態
swingDetectorAdvanced.ResetCooldown();
```

### 2. 取得狀態資訊
```csharp
// 檢查是否在轉向（可以顯示提示）
if (swingDetectorAdvanced.IsRotating()) {
    hintText.text = "請保持手把穩定";
}

// 取得加速度強度（做特效）
float intensity = swingDetectorAdvanced.GetAccelMagnitude();
particleSystem.startSpeed = intensity * 2f;
```

### 3. Debug模式
```
開發階段：
Show Debug Info: ✅
Show Detailed Debug: ✅

正式發布：
Show Debug Info: ❌
Show Detailed Debug: ❌
```

---

## ✅ 檢查清單

- [ ] 已加入 SwingDetectorAdvanced 組件
- [ ] 參數已設定（參考快速設定）
- [ ] 執行遊戲並完成校準
- [ ] 測試轉向是否被正確忽略
- [ ] 測試四個方向都能正確偵測
- [ ] 測試回彈是否被抑制
- [ ] 關閉 Debug 訊息

---

祝你的節奏遊戲開發順利！🎵✨
